You are debugging a Supabase RLS permission error in a Next.js ecommerce app.

CURRENT ERROR:
- "permission denied for table orders"
- Happens when creating an order via /api/orders
- RLS is enabled and working correctly
- Failure indicates the API route is NOT using the service_role key

TASKS:

1. FIND THE ROOT CAUSE
- Locate all Supabase client initializations
- Identify which client is used inside /api/orders and any order-related logic
- Determine whether it uses:
  - anon key
  - authenticated user session
  - cookies-based server client
- Flag this as incorrect for writes

2. FIX THE SERVER CLIENT
- Create (or update) a dedicated Supabase admin client:
  - Uses SUPABASE_SERVICE_ROLE_KEY
  - Does NOT use cookies
  - Does NOT persist sessions
- Example requirements:
  createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, { auth: { persistSession: false } })

3. REFACTOR ORDER CREATION
- Ensure ALL inserts into:
  - orders
  - order_items
  - payments
  are executed using the service_role Supabase client
- Remove any dependency on the currently logged-in user for database permissions

4. VALIDATE SECURITY
- Confirm that:
  - Client-side code never inserts into orders
  - API routes do not rely on auth.uid() for permissions
  - RLS remains enabled on orders
- Explicitly confirm that admin privileges come from API keys, not auth accounts

5. OUTPUT
- Show:
  - The incorrect code
  - The corrected code
  - The final version of /api/orders/route.ts
- Explain briefly why the fix works even when no admin is logged in

IMPORTANT CONSTRAINTS:
- NEVER expose SUPABASE_SERVICE_ROLE_KEY to the client
- NEVER use createServerClient or auth-based Supabase clients for order creation
- Assume production security requirements

Proceed carefully and fix only what is necessary to resolve the permission denied error.
